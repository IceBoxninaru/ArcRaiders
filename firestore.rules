rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function roomDoc(appId, roomId) {
      return get(/databases/$(database)/documents/artifacts/$(appId)/public/data/rooms/$(roomId));
    }

    function isRoomOwner(room) {
      return isSignedIn() && room.exists() && room.data.ownerUid == request.auth.uid;
    }

    function isRoomMember(room) {
      return isSignedIn()
        && room.exists()
        && (room.data.ownerUid == request.auth.uid || room.data.allowedUsers.hasAny([request.auth.uid]));
    }

    // ルームドキュメントのルール
    match /artifacts/{appId}/public/data/rooms/{roomId} {
      allow read: if isSignedIn();
      // 新規作成：ドキュメントが存在しない場合のみ許可
      allow create: if isSignedIn() && !exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/rooms/$(roomId));
      // 更新：オーナーのみ許可
      allow update: if isSignedIn() && resource.data.ownerUid == request.auth.uid;
      // 削除：オーナーのみ許可
      allow delete: if isSignedIn() && resource.data.ownerUid == request.auth.uid;
    }

    // その他のデータ（ピン、マップメタなど）
    match /artifacts/{appId}/public/data/{doc=**} {
      allow read, write: if isSignedIn();
    }
  }
}
