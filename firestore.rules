rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function roomDoc(appId, roomId) {
      return get(/databases/$(database)/documents/artifacts/$(appId)/public/data/rooms/$(roomId));
    }

    function isRoomOwner(room) {
      return isSignedIn() && room.exists() && room.data.ownerUid == request.auth.uid;
    }

    function isRoomMember(room) {
      return isSignedIn()
        && room.exists()
        && (room.data.ownerUid == request.auth.uid || room.data.allowedUsers.hasAny([request.auth.uid]));
    }

    // シンプルに、認証済みなら artifacts/{appId}/public/data 配下は全て許可（appId は環境と合わせてください）
    match /artifacts/{appId}/public/data/{doc=**} {
      allow read, write: if isSignedIn();
    }
  }
}
